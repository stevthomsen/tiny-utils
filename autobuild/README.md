AutoBranch Usage Details
========================

Location of Files
-----------------
##### Scripts
The scripts are, by default, in /work/bin.

###### branch
As the name implies, this script is responsible for the automated branching, and for creating and sending the branch announcement email.

In normal usage in a crontab, invocation is:

        branch [switches] <release_group> [<iteration>]

<iteration> refers to the iteration number. If not specified, "0" (i.e., no iteration) is assumed). Iteration 1 does _not_ include engine/finisher/conditioner; iteration 2+ includes engine/finisher/conditioner; iteration 0 makes no mention of iteration nor engine, etc.

Automated email is sent to the build admins of record, and a branch announcement email is sent to the development team (unless supressed).

Optional switches, mostly useful for debugging, include:

     -send_saved_email  Send the last saved email for the specified release group (and nothing else to be done).  
                        This switch is useful if the last branch was done with email notification suppress,
                        i.e., silently, and it it now desired to announce that branch.

     -noemail           Suppress sending annuncement email, but still sends admin email  
     -keep_email        Keep a copy of the generated email in the local directory after it has been sent  
     -force             Ignore all control files
     -debug             Use "debug" email addresses, and don't actually perform the branch

###### build
This script performs the unattended build submission through Sirius Hub.

##### Control Files
The directory containing the control and configuration files is, by default, /work/cronctrl, and will be referred to as the control directory. The system uses the existence of certain named files to modify its behaviour (see "Control Files" section below for details).

The control directory is also checked for optional email blocks that are used in created the announcement email (see "Email Generation" below).

##### Logs
All log files and transcripts are written to /work/logs.

Crontab
-------
By Design, the crontab entries are static once set up. All daily interaction with the system is through control files created in the control directory.

Following is a sample cron, this one for Limo and Bugatti:

        #  
        # The branches need to be done as close together as feasible  
        #  
        # The builds need to be spaced out so that we don't overwhelm the systems/network  
        #  
        
        # Limo branch #1 - Tu  
        30 17 * * 2     sh -l /work/bin/branch limo 1 > /work/logs/cron_branch_limo.log 2>&1  
        35 17 * * 2     sh -l /work/bin/build limo 1 > /work/logs/cron_build_limo.log 2>&1  
        
        # Limo branch #2 - Th  
        30 17 * * 4     sh -l /work/bin/branch limo 2 > /work/logs/cron_branch_limo.log 2>&1  
        35 19 * * 4     sh -l /work/bin/build limo 2 > /work/logs/cron_build_limo.log 2>&1  
        
        # Bugatti branch - Th  
        30 17 * * 4     sh -l /work/bin/branch bugatti_3_0 > /work/logs/cron_branch_bugatti.log 2>&1  
        55 19 * * 4     sh -l /work/bin/build bugatti_3_0 > /work/logs/cron_build_bugatti.log 2>&1  
        
        #  
        # Manual run  
        #  
        00 17 13 07 *   sh -l /work/bin/branch -noemail limo 0 > /work/logs/cron_branch.log 2>&1  
        15 17 13 07 *   sh -l /work/bin/build limo 0 > /work/logs/cron_build.log 2>&1  

Control Files
-------------
To disable create a file in this directory of one of the following names:

        __all_disable__                 # disables everything
        __branch_disable__              # disable all branching
        __build_disable__               # disable all builds

        __<relgrp>_disable__            # disable branching and building for release group
        __branch_<relgrp>_disable__     # disable release group branching
        __build_<relgrp>_disable__      # disable release group builds

        __email_<relgrp>_disable__      # don't send branching email for release group

And a few disables based upon current day-of-week:

        __branch_<relgrp>_{mon|tue|wed|thu|fri|sat|sun}_disable__  
        __build_<relgrp>_{mon|tue|wed|thu|fri|sat|sun}_disable__  

Note: In all of the above, the file begins and ends with _two_ underscore
characters.

Email Generation
----------------
A base email message is generated by **branch**. This base message contains
the date/branch specfic details, and is not readily modifiable (requires
editting the actual script to do so). An example base block is:

        Ignore if not working on limo or bugatti firmware.

        Greetings All,

        This is a notification email that limo TT/FS LP2, LP3 has branched for weekly 
        release 002.1636 iteration 1. [Note: This iteration does not include the engine 
        nor finisher.]

        Branched: trunk @ 96d91e8b7fd4699fdef44355e4d768bb890892d4  
        Date/time: 08/30/2016 @ 05:30:03 PM PDT

        Use this information to see if your important sha has made it into the release branch.

        Please email us SHAs of any fixes that need to be included but did not make it in.  
        Sooner is better -- including more fixes requires a level of requalification of  
        the weekly release and consumes limited resources. Thus, earlier during qualification  
        is better.

##### Optional Email Blocks
The following optional email blocks are handled in the following order and appended to the
base email block as appropriate

###### Note
Additionally, a file in this directory with one of the names:  

        note.html
        note_<relgrp>.html  

will be included as-is as a paragraph in the notification email.  HTML tags are accepted.

##### Schedule Text
Next, a file in this directory with one of the names:  

        schedule.html  
        schedule_<relgrp>.html  

will also be included as-is in the notificaton email. Note that these files are assumed to be in HTML and will NOT be wrapped as a paragraph.

##### Schedule Graphic
Finally, a .jpg of the name:  

        schedule.jpg  

will be included inline in the email.

At present, the final signature is hardcoded (as is the "To:" and "From:" email addresses).

Deferred/Saved Emails
---------------------
If the email announcement is suppressed, usually through an __email_<relgrp>_disable__ control file, the announcement email is still generated and saved in the current directory (if run from crontab, that will be the home directory of the crontab owner). This email is complete and self-contained, and may be manually sent if desired.

For convenience, a special switch is supported by **branch** to send this saved email:

        branch -send_saved_email

The saved email will be sent (and the saved copy deleted), but nothing else will be done.

Future Enhancements/Ideas
=========================
* cronctrl path as command line argument
* Possible splitting of base email into additional release-group-specific files
* Possible template/substitution for email parts
* Email blocks by day
* Email disable control file
* schedule.jpg by release group and day
* note to &lt;div&gt; instead of &lt;p&gt;
* Split release-group specific block into subdirectories
* Control files: \_\_&lt;operation&gt;\_disable\_&lt;relgrp&gt;\_\_, \_\_all\_disable\_&lt;relgrp&gt;\_\_
* add bcc
* consider debug section in doc
* "majver" to become configurable from command line
